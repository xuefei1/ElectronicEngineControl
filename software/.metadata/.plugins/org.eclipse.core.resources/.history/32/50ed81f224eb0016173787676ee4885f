/*
 * tps_proc.c
 *
 * Status: C
 *
 *  Created on: Feb 4, 2017
 *      Author: xuefei1
 *
 *      Throttle Position Sensor process
 *
 *      *See proj_config.h for acronym translations
 */

#include "tps_proc.h"
#include "apps_motor_proc.h"
#include "altera_up_avalon_de0_nano_adc.h"

OS_EVENT *expected_motor_pos_q;

/*  Task routine for pedal position sensor and motor */
void tps_task(void* pdata) {

	alt_up_de0_nano_adc_dev* adc = alt_up_de0_nano_adc_open_dev(
			DE0_NANO_ADC_0_NAME);

	static INT16U last_apps_1_reading = 0;
	static INT16U last_apps_2_reading = 0;

	expected_motor_pos_q = OSQCreate((void*) motor_pos_q_buf,
			EXPECTED_MOTOR_POS_Q_SIZE_BYTE / sizeof(INT16U));
	if (expected_motor_pos_q == NULL) {
		printf("failed to init q\n");
		return;
	}

	while (1) {
		alt_up_de0_nano_adc_update(adc);

		INT16U apps_1_reading = alt_up_de0_nano_adc_read(adc,
				APPS_1_ADC_CHANNEL);
		INT16U apps_2_reading = alt_up_de0_nano_adc_read(adc,
				APPS_2_ADC_CHANNEL);

		if (APPS_VALUE_CHANGED(apps_1_reading,
				last_apps_1_reading)
				|| APPS_VALUE_CHANGED(apps_2_reading, last_apps_2_reading)) {
			if (APPS_VALUE_MISMATCH(apps_1_reading, apps_2_reading)) {
				//we have a failure, turn off motor, indicate failure and block

			} else {
				//determine new motor position

			}
		}
		OSTimeDlyHMSM(APPS_MOTOR_TASK_DELAY_HOURS,
				APPS_MOTOR_TASK_DELAY_MINUTES, APPS_MOTOR_TASK_DELAY_SECONDS,
				APPS_MOTOR_TASK_DELAY_MILLISEC);
	}
}
